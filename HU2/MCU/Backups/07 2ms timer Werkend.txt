/*************************************************************************
Title:    Main Control Unit HU-2
Author:   Jeroen Mostert, LCD Library by peterfleury
File:     main.c
Software: AVR-GCC 4.x
Hardware: Main Control Unit V1.0
**************************************************************************/

#include <stdlib.h>
#include <avr/io.h>
#include <avr/pgmspace.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include "lcd.h"

volatile int lcd_status = 0, refresh_rate = 0;			// 0 = Motorcontroller, 1 = Watercooling loop, 2 = Batteries
volatile char Linebuffer0[21], Linebuffer1[21], Linebuffer2[21], Linebuffer3[21];	// LCD Line Buffer

ISR(ADC_vect)							// ADC Conversion done Intterrupt
{	
	snprintf (Linebuffer0, sizeof Linebuffer0,"ADC: %d", ADC);
}

ISR(INT5_vect)							// LCD Switch External Interrupt
{
	_delay_ms(5);						// Delay for key debounce
	if (PINE & (1<<PE5)){
			if (lcd_status == 2){		
 					lcd_status = 0;		// Reset lcd status
			}
			else lcd_status++;	
			lcd_refresh();	
	}
}

ISR(TIMER2_OVF_vect)					// Real Time Clock Interrupt
{
//		if (lcd_status == 2){
//			lcd_status = 0;				// reset lcd status
//		}
//		else 
//		lcd_status++;	
		TCNT2 = 192;					// Set initial counter value(0.25 Seconds)
//		ADCSRA |= (1 << ADSC);
//		lcd_refresh();
		if(refresh_rate == 4){
			refresh_rate = 0;
			lcd_refresh();
		}
		else {
			refresh_rate++;
			lcd_fast_refresh();
		}
}

ISR(TIMER0_OVF_vect)
{
	TCNT0 = 130;
	ADCSRA |= (1 << ADSC);
}

void lcd_fast_refresh(void)				// LCD Fast Refresh for Speed
{
	lcd_gotoxy(0 ,0);					// Set display to Line 0, Character 0
	lcd_puts(Linebuffer0);
}

void lcd_refresh(void)					// LCD Refresh for Whole LCD
{
	lcd_clrscr();
	
	if (lcd_status == 0){
	lcd_motor_screen();
	}
	if (lcd_status == 1){
	lcd_water_screen();
	}
	if (lcd_status == 2){
	lcd_batteries_screen();
	}
	
	lcd_gotoxy(0 ,0);					// Set display to Line 0, Character 0
	lcd_puts(Linebuffer0);
	
	lcd_gotoxy(40 ,0);					// Set display to Line 1, Character 0
	lcd_puts(Linebuffer1);
	
	lcd_gotoxy(20 ,0);					// Set display to Line 2, Character 0
	lcd_puts(Linebuffer2);
	
	lcd_gotoxy(20 ,1);					// Set display to Line 3, Character 0
	lcd_puts(Linebuffer3);
}

void lcd_motor_screen(void)				// LCD Motor Control Screen
{
	snprintf (Linebuffer1, sizeof Linebuffer1,"     C MOTOR       C");
	snprintf (Linebuffer2, sizeof Linebuffer2,"     C CONTR       C");
}

void lcd_water_screen(void)				// LCD Watercooling Screen
{
	snprintf (Linebuffer1, sizeof Linebuffer1,"     C  WATER      C");
	snprintf (Linebuffer2, sizeof Linebuffer2,"    L/m FLOW     L/m");
}

void lcd_batteries_screen(void)			// LCD Batteries Screen
{
		snprintf (Linebuffer1, sizeof Linebuffer1,"     Battery        ");
		snprintf (Linebuffer2, sizeof Linebuffer2,"     Screen         ");
}

void lcd_blue_screen(void)				// LCD Press Blue Button Screen
{
	snprintf (Linebuffer0, sizeof Linebuffer0," Press Blue Button  ");
}

void lcd_green_screen(void)				// LCD Press Blue Button Screen
{
	snprintf (Linebuffer0, sizeof Linebuffer0," Press Green Button ");
}

void lcd_race_screen(void)				// LCD Race Screen/Home Screen
{
//	snprintf (Linebuffer0, sizeof Linebuffer0,"  Speed:      KM/H  ");
	snprintf (Linebuffer3, sizeof Linebuffer3,"H:   V/    A L:    V");
}

void init_RTC(void)						// 4Hz Clock Initialization (Timer Counter 2)
{
		ASSR  = (1<< AS2);						// Enable asynchronous mode
		TCNT2 = 192;							// Set initial counter value(0.25 Seconds)
		TCCR2A |= (1 << CS02)|(1 << CS00);		// 128 Prescaler ((255*128)/32.786 = 1Hz)
		TIFR2   = (1 << TOV2);					// Clear interrupt flags
		TIMSK2  = (1 << TOIE2);					// Enable TOV2 interrupt
}

void init_ADC(void)						// ADC Initialization
{
		ADCSRA |= (1 << ADPS2) | (1 << ADPS1) | (1 << ADPS0);	// 128 PreScaler
//		ADMUX |= (1 << ADLAR);					// Left Align Bits
		ADMUX |= (1 << REFS0);					// Set 5V Ref Voltage
		ADCSRA |= (1 << ADEN)|(1 << ADIE);		// Enable ADC and Interrupt
		// 2 ms zooi
//		ADCSRB |= (1 << ADTS2);					// Start Conversion on Timer Counter 0 Overflow
		
}

void init_TIMER0(void)					// 500HZ Clock Initialization(Timer Counter 0)		
{
		TCCR0A |= (1 << CS02);					// 256 Prescaler
		TCNT0 = 130;							// 130 timer Counter
		TIMSK0 |= (1 << TOIE0);					// Overflow Interrupt Enable
}

int main()
{
		init_ADC();	
		init_RTC();
		init_TIMER0();

	    DDRE &=~ (1 << PE5);        // Pin PE5 input              
	    PORTE |= (1 << PE5);        // Pin PE5 pull-up enabled    

		EIMSK |= (1 << INT5);					// Enable Interrupt 5
		EICRB  |= (1 << ISC51) | (1 << ISC50);	// Falling edge creates interrupt
	
		lcd_init(LCD_DISP_ON);		// Initialize display, cursor off
        lcd_clrscr();				// Clear display, set display to Line 0, char 0
		
		sei();						// Enable Global Interrupts
		
		lcd_race_screen();
		lcd_motor_screen();
	
		lcd_refresh();
		
		sei();
		
		while(1){
			
		}
		
}
